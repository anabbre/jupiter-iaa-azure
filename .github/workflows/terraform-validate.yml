name: terraform-validate

on:
  # Ejecuta la validación cuando se suben cambios a main…
  push:
    branches: [ main ]
    paths:
      - 'docs/examples/**'                        # …solo si cambian ejemplos
      - '.github/workflows/terraform-validate.yml'
  # …y también en Pull Requests que toquen ejemplos o este YAML.
  pull_request:
    paths:
      - 'docs/examples/**'
      - '.github/workflows/terraform-validate.yml'

# Permisos mínimos para leer el repo (principio de mínimo privilegio)
permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest   # Runner Linux estándar de GitHub

    steps:
      # 1) Trae el código del repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Descubre todas las carpetas bajo docs/examples que tengan .tf
      - name: List Terraform example folders
        id: discover
        shell: bash
        run: |
          # Busca .tf y devuelve la lista única de carpetas (excluye .terraform)
          mapfile -t TF_DIRS < <(find docs/examples -type f -name "*.tf" \
            -not -path "*/.terraform/*" -printf '%h\n' | sort -u)

          if [ ${#TF_DIRS[@]} -eq 0 ]; then
            echo "found=false" >> "$GITHUB_OUTPUT"     # No hay ejemplos
          else
            printf '%s\n' "${TF_DIRS[@]}" > tf_dirs.txt # Guarda las rutas
            echo "found=true" >> "$GITHUB_OUTPUT"
          fi

      # 3) Instala Terraform (sin wrapper para ver los comandos tal cual)
      - name: Setup Terraform
        if: steps.discover.outputs.found == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5
          terraform_wrapper: false

      # 4) Formatea e inicializa en modo offline y valida cada carpeta
      - name: Validate each folder
        if: steps.discover.outputs.found == 'true'
        shell: bash
        run: |
          set -euo pipefail
          while IFS= read -r dir; do
            echo "➡️  Validating $dir"
            pushd "$dir" >/dev/null

            # Verifica estilo/forma de todos los .tf (falla si hay diferencias)
            terraform fmt -check -recursive

            # Init sin backend (OFFLINE): no toca Azure ni backends remotos
            terraform init -backend=false -input=false

            # Valida sintaxis y dependencias
            terraform validate

            popd >/dev/null
          done < tf_dirs.txt

      # 5) Si algo falla, sube artefactos con logs/estados para inspección
      - name: Upload validation logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: tf-validate-logs
          path: |
            **/.terraform/**/terraform.tfstate
            **/.terraform/**/logs/*
          if-no-files-found: ignore

